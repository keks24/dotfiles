#!/bin/bash
############################################################################
# Copyright 2020-2025 Ramon Fischer                                        #
#                                                                          #
# Licensed under the Apache License, Version 2.0 (the "License");          #
# you may not use this file except in compliance with the License.         #
# You may obtain a copy of the License at                                  #
#                                                                          #
#     http://www.apache.org/licenses/LICENSE-2.0                           #
#                                                                          #
# Unless required by applicable law or agreed to in writing, software      #
# distributed under the License is distributed on an "AS IS" BASIS,        #
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. #
# See the License for the specific language governing permissions and      #
# limitations under the License.                                           #
############################################################################

command_list=(\
                "/usr/bin/git" \
                "/usr/bin/locate" \
                "/usr/bin/nproc" \
                "/usr/bin/ssh-add" \
                "/usr/sbin/updatedb" \
             )
checkCommands()
{
    unalias "${command_list[@]}" 2>/dev/null

    for current_command in "${command_list[@]}"
    do
        if [[ ! $(command -v "${current_command}") ]]
        then
            echo -e "\e[01;31mCould not find command '${current_command}'.\e[0m"
            exit 1
        fi
    done
}

checkCommands

# define global variables
current_username="${USER}"
home_directory="/home/${current_username}"
git_directory="${home_directory}/git"
db_filename="directory_index.db"
directory_index_file="${git_directory}/${db_filename}"
available_processors=$(/usr/bin/nproc --all)
declare -a prune_paths_array
# trailing slashes for directories must be left out!
# spaces must be escaped with backslash!
prune_paths_array=(\
                    "${git_directory}/external/github.com/keks24/gitea/integrations/gitea-repositories-meta" \
                    "${git_directory}/external/github.com/fritzbox/freetz-ng/make/pkgs/git/files/root/etc" \
                  )

# scan git directory and save binary index file
## the array needs to be expanded via "echo"!
## unfortunately, there is no way to only include ".git/" directories.
/usr/sbin/updatedb \
    --prune-bind-mounts="no" \
    --prunefs="" \
    --prunenames="" \
    --add-prunepaths="$(echo ${prune_paths_array[@]})" \
    --database-root="${git_directory}" \
    --output="${directory_index_file}"

# cache ssh key password
/usr/bin/ssh-add "${home_directory}/.local/etc/update_git_repositories/ssh_key"

# update git repositories
## debugging this is a bit difficult, since it runs in parallel.
## the outputs of the "echo" and "git pull" are also distorted.
## no inputs can be done in the subshell!
/usr/bin/locate --database="${directory_index_file}" --regexp "\.git$" --null \
    | xargs \
        --null \
        --no-run-if-empty \
        --max-procs="${available_processors}" \
        --replace="{}" \
        /bin/bash -c 'repository_directory="{}" && \
            echo -e "\n\e[01;34m### Updating: ${repository_directory%\.git} ###\e[0m" && \
            pushd "${repository_directory%\.git}" >/dev/null && \
            git pull --recurse-submodules --force && \
            popd >/dev/null'
